{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 46, "column": 0}, "map": {"version":3,"sources":["file:///D:/react-virus-total-extension%20%281%29/app/api/scan/route.ts"],"sourcesContent":["import { type NextRequest, NextResponse } from \"next/server\"\n\nconst VIRUSTOTAL_API_KEY = process.env.VIRUSTOTAL_API_KEY || \"\"\nconst VIRUSTOTAL_API_URL = \"https://www.virustotal.com/api/v3\"\n\nasync function waitForAnalysis(analysisId: string, maxRetries = 10): Promise<any> {\n  for (let i = 0; i < maxRetries; i++) {\n    const response = await fetch(`${VIRUSTOTAL_API_URL}/analyses/${analysisId}`, {\n      headers: {\n        \"x-apikey\": VIRUSTOTAL_API_KEY,\n      },\n    })\n\n    if (!response.ok) {\n      throw new Error(\"Failed to get analysis from VirusTotal\")\n    }\n\n    const data = await response.json()\n    const status = data.data.attributes.status\n\n    console.log(`[v0] Analysis status: ${status}, retry ${i + 1}/${maxRetries}`)\n\n    // If completed, return the data\n    if (status === \"completed\") {\n      return data\n    }\n\n    // Wait 2 seconds before next retry\n    await new Promise((resolve) => setTimeout(resolve, 2000))\n  }\n\n  throw new Error(\"Analysis timed out\")\n}\n\nexport async function POST(request: NextRequest) {\n  try {\n    const { url } = await request.json()\n\n    console.log(\"[v0] Scanning URL:\", url)\n\n    if (!url) {\n      return NextResponse.json({ error: \"URL is required\" }, { status: 400 })\n    }\n\n    if (!VIRUSTOTAL_API_KEY) {\n      return NextResponse.json({ error: \"VirusTotal API key not configured\" }, { status: 500 })\n    }\n\n    const urlId = Buffer.from(url).toString(\"base64\").replace(/=/g, \"\")\n    console.log(\"[v0] Checking for cached results, URL ID:\", urlId)\n\n    const cachedResponse = await fetch(`${VIRUSTOTAL_API_URL}/urls/${urlId}`, {\n      headers: {\n        \"x-apikey\": VIRUSTOTAL_API_KEY,\n      },\n    })\n\n    if (cachedResponse.ok) {\n      console.log(\"[v0] Found cached results\")\n      const cachedData = await cachedResponse.json()\n      const stats = cachedData.data.attributes.last_analysis_stats\n\n      console.log(\"[v0] Cached stats received:\", JSON.stringify(stats))\n\n      // VirusTotal returns these exact field names\n      const result = {\n        harmless: stats.harmless || 0,\n        suspicious: stats.suspicious || 0,\n        malicious: stats.malicious || 0,\n        undetected: stats.undetected || 0,\n      }\n\n      console.log(\"[v0] Parsed result:\", JSON.stringify(result))\n\n      let status = \"safe\"\n      if (result.malicious > 0) {\n        status = \"malicious\"\n      } else if (result.suspicious > 0) {\n        status = \"suspicious\"\n      }\n\n      console.log(\"[v0] Final status:\", status)\n\n      return NextResponse.json({\n        status,\n        stats: result,\n        permalink: `https://www.virustotal.com/gui/url/${urlId}`,\n      })\n    }\n\n    console.log(\"[v0] No cached results, submitting for new scan\")\n    const submitResponse = await fetch(`${VIRUSTOTAL_API_URL}/urls`, {\n      method: \"POST\",\n      headers: {\n        \"x-apikey\": VIRUSTOTAL_API_KEY,\n        \"Content-Type\": \"application/x-www-form-urlencoded\",\n      },\n      body: `url=${encodeURIComponent(url)}`,\n    })\n\n    if (!submitResponse.ok) {\n      const errorText = await submitResponse.text()\n      console.error(\"[v0] Submit error:\", errorText)\n      throw new Error(\"Failed to submit URL to VirusTotal\")\n    }\n\n    const submitData = await submitResponse.json()\n    const analysisId = submitData.data.id\n    console.log(\"[v0] Analysis ID:\", analysisId)\n\n    const analysisData = await waitForAnalysis(analysisId)\n    const stats = analysisData.data.attributes.stats\n\n    console.log(\"[v0] Analysis stats:\", JSON.stringify(stats))\n\n    const result = {\n      harmless: stats.harmless || 0,\n      suspicious: stats.suspicious || 0,\n      malicious: stats.malicious || 0,\n      undetected: stats.undetected || 0,\n    }\n\n    // Determine status\n    let status = \"safe\"\n    if (result.malicious > 0) {\n      status = \"malicious\"\n    } else if (result.suspicious > 0) {\n      status = \"suspicious\"\n    }\n\n    console.log(\"[v0] Final status:\", status)\n\n    return NextResponse.json({\n      status,\n      stats: result,\n      permalink: `https://www.virustotal.com/gui/url/${urlId}`,\n    })\n  } catch (error) {\n    console.error(\"[v0] Error scanning URL:\", error)\n    return NextResponse.json({ error: error instanceof Error ? error.message : \"Failed to scan URL\" }, { status: 500 })\n  }\n}\n"],"names":[],"mappings":"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"}}]
}